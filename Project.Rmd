---
title: "Final Project - Data Mining"
authors: "Dawid Michal Roch Móll, Jonathan Zinzan Salisbury Vega, Joan Sansó Pericàs, Joan Vilella Candia, Julián Wallis Medina"
date: Sys.Date()
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(ggplot2)
library(dplyr)
library(ggdist)

library(networkD3)


```

### Comentarios
- Casi todos son Full Time
- Nuevas columnas: 

## Exploratory Data Analysis

```{r}
df <- read.csv("salaries.csv", stringsAsFactors = TRUE)
summary(df)
str(df)
```



```{r}
anyNA(df)
```

```{r}
df$salary <- NULL

df$remote_ratio <- as.factor(df$remote_ratio)
levels(df$remote_ratio) <- list("Office" = 0, "Hybrid" = 50,  "Remote" = 100)

df$salaryGroup <- cut(df$salary_in_usd, c(0, 25000, 50000, 75000, 100000, 125000, 150000, 200000, 250000, 1000000))
df$salaryGroup <- as.factor(df$salaryGroup)
```

```{r}
# group df$employee_residence to different regions in the world. The data is in ISO 3166-1 alpha-2 format. Regions like North America, Europe, Asia, etc.
df$employee_region <- as.factor(df$employee_residence)
levels(df$employee_region) <- list(  
  "North America" = c("US", "CA", "MX"),   
  "South America" = c("AR", "BO", "BR", "CL", "CO", "EC", "PE", "PY", "UY", "VE"),   
  "Central America" = c("BZ", "CR", "DO", "GT", "HN", "NI", "PA", "PR", "SV"),
  "Europe" = c("AT", "AX", "BE", "BG", "CH", "CY", "CZ", "DE", "DK", "EE", "ES", "FI", "FR", "GB", "GR", "HR", "HU", "IE", "IS", "IT", "JE", "LT", "LU", "LV", "MD", "MT", "NL", "NO", "PL", "PT", "RO", "RU", "RS", "SE", "SI", "SK", "TR", "UA"),
  "Asia" = c("AE", "AF", "AM", "AZ", "BD", "BH", "BN", "CN", "GE", "HK", "ID", "IL", "IN", "IQ", "IR", "JO", "JP", "KG", "KH", "KP", "KR", "KW", "KZ", "LA", "LB", "LK", "MM", "MN", "MO", "MV", "MY", "NP", "OM", "PH", "PK", "QA", "SA", "SG", "SY", "TH", "TJ", "TM", "TW", "UZ", "VN", "YE"),   
  "Africa" = c("AO", "BF", "BI", "BJ", "BW", "CD", "CF", "CG", "CI", "CM", "CV", "DJ", "DZ", "EG", "EH", "ER", "ET", "GA", "GH", "GM", "GN", "GQ", "GW", "KE", "KM", "LR", "LS", "LY", "MA", "MG", "ML", "MR", "MU", "MW", "MZ", "NA", "NE", "NG", "RE", "RW", "SC", "SD", "SH", "SL", "SN", "SO", "ST", "SZ", "TD", "TG", "TN", "TZ", "UG", "YT", "ZA", "ZM", "ZW"), 
  "Oceania" = c("AU", "FJ", "FM", "GU", "KI", "MH", "MP", "NC", "NF", "NR", "NU", "NZ", "PF", "PG", "PN", "PW", "SB", "TK", "TO", "TV", "UM", "VU", "WF", "WS"))

df$company_region <- as.factor(df$company_location)
levels(df$company_region) <- list(  
  "North America" = c("US", "CA", "MX"),   
  "South America" = c("AR", "BO", "BR", "CL", "CO", "EC", "PE", "PY", "UY", "VE"),   
  "Central America" = c("BZ", "CR", "DO", "GT", "HN", "NI", "PA", "PR", "SV"),
  "Europe" = c("AT", "AL", "AX", "BE", "BG", "CH", "CY", "CZ", "DE", "DK", "EE", "ES", "FI", "FR", "GB", "GR", "HR", "HU", "IE", "IS", "IT", "JE", "LT", "LU", "LV", "MD", "MT", "NL", "NO", "PL", "PT", "RO", "RU", "RS", "SE", "SI", "SK", "TR", "UA"),
  "Asia" = c("AE", "AF", "AM", "AZ", "BD", "BH", "BN", "CN", "GE", "HK", "ID", "IL", "IN", "IQ", "IR", "JO", "JP", "KG", "KH", "KP", "KR", "KW", "KZ", "LA", "LB", "LK", "MM", "MN", "MO", "MV", "MY", "NP", "OM", "PH", "PK", "QA", "SA", "SG", "SY", "TH", "TJ", "TM", "TW", "UZ", "VN", "YE"),   
  "Africa" = c("AO", "BF", "BI", "BJ", "BW", "CD", "CF", "CG", "CI", "CM", "CV", "DJ", "DZ", "EG", "EH", "ER", "ET", "GA", "GH", "GM", "GN", "GQ", "GW", "KE", "KM", "LR", "LS", "LY", "MA", "MG", "ML", "MR", "MU", "MW", "MZ", "NA", "NE", "NG", "RE", "RW", "SC", "SD", "SH", "SL", "SN", "SO", "ST", "SZ", "TD", "TG", "TN", "TZ", "UG", "YT", "ZA", "ZM", "ZW"), 
  "Oceania" = c("AU", "AS", "FJ", "FM", "GU", "KI", "MH", "MP", "NC", "NF", "NR", "NU", "NZ", "PF", "PG", "PN", "PW", "SB", "TK", "TO", "TV", "UM", "VU", "WF", "WS"))

summary(df)
```

```{r}

# I've got two columns, one with the company region and another with the employee region. I want to create a sankey diagram / migration flow chart
# that shows the number of employees that are from a certain region and work in a certain region.
# For it I have to create an auxiliar data frame with the number of employees that are from a certain region and work in a certain region.

# Create the auxiliar data frame where the rows and columns are the regions and the values are the number of employees that are from a certain region and work in a certain region.
# The auxiliar data frame will have the same number of rows and columns as the number of regions.
aux <- data.frame(matrix(0, nrow = length(levels(df$company_region)), ncol = length(levels(df$company_region))))
colnames(aux) <- levels(df$company_region)
rownames(aux) <- levels(df$company_region)

# Now calculate the number of employees that are from a certain region and work in a certain region.
for (i in 1:nrow(aux)) {
  for (j in 1:ncol(aux)) {
    aux[i, j] <- length(which(df$company_region == colnames(aux)[j] & df$employee_region == rownames(aux)[i]))
  }
}

# I need a long format
data_long <- aux %>%
  rownames_to_column %>%
  gather(key = 'key', value = 'value', -rowname) %>%
  filter(value > 0)
colnames(data_long) <- c("source", "target", "value")
data_long$target <- paste(data_long$target, " ", sep="")

# From these flows we need to create a node data frame: it lists every entities involved in the flow
nodes <- data.frame(name=c(as.character(data_long$source), as.character(data_long$target)) %>% unique())
 
# With networkD3, connection must be provided using id, not using real name like in the links dataframe.. So we need to reformat it.
data_long$IDsource=match(data_long$source, nodes$name)-1 
data_long$IDtarget=match(data_long$target, nodes$name)-1



# Make the Network
sankeyNetwork(Links = data_long, Nodes = nodes,
                     Source = "IDsource", Target = "IDtarget",
                     Value = "value", NodeID = "name", 
                     sinksRight=FALSE, nodeWidth=40, fontSize=13, nodePadding=20)

```



```{r}
levels(factor(df$job_title))  
```

```{r}
df$industry <- ifelse( grepl("data", df$job_title, ignore.case = T), "DATA", "OTHER")
df$industry <- ifelse( grepl("machine", df$job_title, ignore.case = T), "ML/AI", df$industry)
df$industry <- ifelse( grepl("ML", df$job_title, ignore.case = T), "ML/AI", df$industry)
df$industry <- ifelse( grepl("AI", df$job_title, ignore.case = T), "ML/AI", df$industry)
df$industry <- as.factor(df$industry)

df$boss <- ifelse(grepl("head", df$job_title, ignore.case = T), "YES", "NO")
df$boss <- ifelse(grepl("lead", df$job_title, ignore.case = T), "YES", df$boss)
df$boss <- ifelse(grepl("principal", df$job_title, ignore.case = T), "YES", df$boss)
df$boss <- ifelse(grepl("director", df$job_title, ignore.case = T), "YES", df$boss)
df$boss <- as.factor(df$boss)

df$role <- ifelse(grepl("scientist", df$job_title, ignore.case = T), "SCIENTIST", "OTHER")
df$role <- ifelse(grepl("engineer", df$job_title, ignore.case = T), "ENGINEER", df$role)
df$role <- ifelse(grepl("analyst", df$job_title, ignore.case = T), "ANALYST", df$role)
df$role <- ifelse(grepl("manager", df$job_title, ignore.case = T), "MANAGER", df$role)
df$role <- ifelse(grepl("architect", df$job_title, ignore.case = T), "ARCHITECT", df$role)
df$role <- ifelse(grepl("developer", df$job_title, ignore.case = T), "DEVELOPER", df$role)
df$role <- as.factor(df$role)

df$research <- ifelse(grepl("research", df$job_title, ignore.case = T), "YES", "NO")
df$research <- as.factor(df$research)

summary(df)

```
```{r}
mean(df$salary_in_usd)
mean(df[df$boss == 'NO', 'salary_in_usd'])
mean(df[df$boss == 'YES', 'salary_in_usd'])

```

```{r}
numerics_names <- colnames(df[, sapply(df, is.numeric)])
factors_names <- colnames(df[, sapply(df, is.factor)])

for (i in 1:length(numerics_names)){
  print(ggplot(df, aes_string(x= numerics_names[i])) +
    ggdist::stat_halfeye(
      adjust=0.5,
      justification = -.2,
      .width=0
    ) +
    geom_boxplot(
      width = .1,
      alpha = 0.5
    ) +
     labs(title=paste("Distribution and boxplot of",numerics_names[i]), y="count"))
}

for (i in 1:length(factors_names)){
  print(ggplot(df, aes_string(x= factors_names[i])) +
    geom_bar()+
     labs(title=paste("Histogram of",factors_names[i]),y="count"))
}
```


```{r}
ggplot(df, aes(x = as.factor(work_year) , y = salary_in_usd)) +
         geom_boxplot() +
         labs(title = "salary_in_usd vs bedrooms")

ggplot(df, aes(x = experience_level , y = salary_in_usd)) +
         geom_boxplot() +
         labs(title = "salary_in_usd vs experience_level")

ggplot(df, aes(x = employment_type , y = salary_in_usd)) +
         geom_boxplot() +
         labs(title = "salary_in_usd vs employment_type")

ggplot(df, aes(x = job_title , y = salary_in_usd)) +
         geom_boxplot() +
         labs(title = "salary_in_usd vs job_title")

ggplot(df, aes(x = employee_residence , y = salary_in_usd)) +
         geom_boxplot() +
         labs(title = "salary_in_usd vs employee_residence")

ggplot(df, aes(x = company_size , y = salary_in_usd)) +
         geom_boxplot() +
         labs(title = "salary_in_usd vs company_size")

ggplot(df, aes(x = company_size , y = salary_in_usd)) +
         geom_boxplot() +
         labs(title = "salary_in_usd vs company_size")

ggplot(df, aes(x = role , y = salary_in_usd)) +
         geom_boxplot() +
         labs(title = "salary_in_usd vs role")

ggplot(df, aes(x = industry , y = salary_in_usd)) +
         geom_boxplot() +
         labs(title = "salary_in_usd vs industry")

ggplot(df, aes(x = boss , y = salary_in_usd)) +
         geom_boxplot() +
         labs(title = "salary_in_usd vs boss")

ggplot(df, aes(x = research , y = salary_in_usd)) +
         geom_boxplot() +
         labs(title = "salary_in_usd vs research")

```

```{r}
plot(df$employee_residence, df$salary_in_usd, xlab="Employee Residence", ylab="Salary in USD")
plot(df$company_size, df$salary_in_usd, xlab="Company Size", ylab="Salary in USD")
plot(df$company_location, df$salary_in_usd, xlab="Company Location", ylab="Salary in USD")
plot(df$experience_level, df$salary_in_usd, xlab="Experience Level", ylab="Salary in USD")
plot(df$remote_ratio, df$salary_in_usd, xlab="Remote Ratio", ylab="Salary in USD")
```

```{r}

y_2020 <- df[df$work_year == 2020,]
y_2021 <- df[df$work_year == 2021,]
y_2022 <- df[df$work_year == 2022,]

y_2020 <- y_2020 %>% group_by(remote_ratio) %>% summarise(count = n())
y_2021 <- y_2021 %>% group_by(remote_ratio) %>% summarise(count = n())
y_2022 <- y_2022 %>% group_by(remote_ratio) %>% summarise(count = n())

y_2020$percentage <- y_2020$count / sum(y_2020$count) * 100
y_2021$percentage <- y_2021$count / sum(y_2021$count) * 100
y_2022$percentage <- y_2022$count / sum(y_2022$count) * 100

y_2020$work_year <- 2020
y_2021$work_year <- 2021
y_2022$work_year <- 2022

y <- rbind(y_2020, y_2021, y_2022)

ggplot(y, aes(x = work_year, y = percentage, group = remote_ratio, color = remote_ratio)) + geom_line() + geom_point() + labs(x = "Work Year", y = "Percentage of Remote Ratio", title = "Remote Ratio by Work Year") + theme(plot.title = element_text(hjust = 0.5))
```
# Questions

## 1. 
## 2. 
## 3. 
## 4.
## 5. 
## 6. 
## 7. Can we predict which employees are at risk of leaving their company? 

This could be useful for companies who want to retain their top talent and for employees that are underpaid. We could use different factors such to determine which employees are underpaid compared to their peers.

Our process will consist of the following steps:
1.

- Experience level
- Industry
- Employee Region
- Company Size
- Industry
- Role
- Boss
- Research

- Remote Ratio

```{r}

```


## 8.
## 9. 
## 10. 
## 11. 
## 12.
## 13. 
## 14. 

