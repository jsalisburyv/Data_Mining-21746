---
title: "Final Project - Data Mining"
authors: "Dawid Michal Roch Móll, Jonathan Zinzan Salisbury Vega, Joan Sansó Pericàs, Joan Vilella Candia, Julián Wallis Medina"
date: Sys.Date()
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(ggplot2)
library(dplyr)
library(ggdist)
library(tidyverse)
library(plotly)
library(networkD3)

set.seed(999)
```

### Comentarios
- Casi todos son Full Time
- Nuevas columnas:

## Exploratory Data Analysis

```{r}
df <- read.csv("salaries.csv", stringsAsFactors = TRUE)
summary(df)
str(df)
```

```{r}
anyNA(df)
```

```{r}
df$ID <- seq.int(nrow(df))
df$salary <- NULL

df$remote_ratio <- as.factor(df$remote_ratio)
levels(df$remote_ratio) <- list("Office" = 0, "Hybrid" = 50,  "Remote" = 100)

df$salary_group <- cut(df$salary_in_usd, c(0, 25000, 50000, 75000, 100000, 125000, 150000, 200000, 250000, 1000000))
df$salary_group <- as.factor(df$salary_group)
```

```{r}
# group df$employee_residence to different regions in the world. The data is in ISO 3166-1 alpha-2 format. Regions like North America, Europe, Asia, etc.
df$employee_region <- as.factor(df$employee_residence)
levels(df$employee_region) <- list(  
  "North America" = c("US", "CA", "MX"),   
  "South America" = c("AR", "BO", "BR", "CL", "CO", "EC", "PE", "PY", "UY", "VE"),   
  "Central America" = c("BZ", "CR", "DO", "GT", "HN", "NI", "PA", "PR", "SV"),
  "Europe" = c("AT", "AX", "BE", "BG", "CH", "CY", "CZ", "DE", "DK", "EE", "ES", "FI", "FR", "GB", "GR", "HR", "HU", "IE", "IS", "IT", "JE", "LT", "LU", "LV", "MD", "MT", "NL", "NO", "PL", "PT", "RO", "RU", "RS", "SE", "SI", "SK", "TR", "UA"),
  "Asia" = c("AE", "AF", "AM", "AZ", "BD", "BH", "BN", "CN", "GE", "HK", "ID", "IL", "IN", "IQ", "IR", "JO", "JP", "KG", "KH", "KP", "KR", "KW", "KZ", "LA", "LB", "LK", "MM", "MN", "MO", "MV", "MY", "NP", "OM", "PH", "PK", "QA", "SA", "SG", "SY", "TH", "TJ", "TM", "TW", "UZ", "VN", "YE"),   
  "Africa" = c("AO", "BF", "BI", "BJ", "BW", "CD", "CF", "CG", "CI", "CM", "CV", "DJ", "DZ", "EG", "EH", "ER", "ET", "GA", "GH", "GM", "GN", "GQ", "GW", "KE", "KM", "LR", "LS", "LY", "MA", "MG", "ML", "MR", "MU", "MW", "MZ", "NA", "NE", "NG", "RE", "RW", "SC", "SD", "SH", "SL", "SN", "SO", "ST", "SZ", "TD", "TG", "TN", "TZ", "UG", "YT", "ZA", "ZM", "ZW"), 
  "Oceania" = c("AU", "FJ", "FM", "GU", "KI", "MH", "MP", "NC", "NF", "NR", "NU", "NZ", "PF", "PG", "PN", "PW", "SB", "TK", "TO", "TV", "UM", "VU", "WF", "WS"))

df$company_region <- as.factor(df$company_location)
levels(df$company_region) <- list(  
  "North America" = c("US", "CA", "MX"),   
  "South America" = c("AR", "BO", "BR", "CL", "CO", "EC", "PE", "PY", "UY", "VE"),   
  "Central America" = c("BZ", "CR", "DO", "GT", "HN", "NI", "PA", "PR", "SV"),
  "Europe" = c("AT", "AL", "AX", "BE", "BG", "CH", "CY", "CZ", "DE", "DK", "EE", "ES", "FI", "FR", "GB", "GR", "HR", "HU", "IE", "IS", "IT", "JE", "LT", "LU", "LV", "MD", "MT", "NL", "NO", "PL", "PT", "RO", "RU", "RS", "SE", "SI", "SK", "TR", "UA"),
  "Asia" = c("AE", "AF", "AM", "AZ", "BD", "BH", "BN", "CN", "GE", "HK", "ID", "IL", "IN", "IQ", "IR", "JO", "JP", "KG", "KH", "KP", "KR", "KW", "KZ", "LA", "LB", "LK", "MM", "MN", "MO", "MV", "MY", "NP", "OM", "PH", "PK", "QA", "SA", "SG", "SY", "TH", "TJ", "TM", "TW", "UZ", "VN", "YE"),   
  "Africa" = c("AO", "BF", "BI", "BJ", "BW", "CD", "CF", "CG", "CI", "CM", "CV", "DJ", "DZ", "EG", "EH", "ER", "ET", "GA", "GH", "GM", "GN", "GQ", "GW", "KE", "KM", "LR", "LS", "LY", "MA", "MG", "ML", "MR", "MU", "MW", "MZ", "NA", "NE", "NG", "RE", "RW", "SC", "SD", "SH", "SL", "SN", "SO", "ST", "SZ", "TD", "TG", "TN", "TZ", "UG", "YT", "ZA", "ZM", "ZW"), 
  "Oceania" = c("AU", "AS", "FJ", "FM", "GU", "KI", "MH", "MP", "NC", "NF", "NR", "NU", "NZ", "PF", "PG", "PN", "PW", "SB", "TK", "TO", "TV", "UM", "VU", "WF", "WS"))

summary(df)
```

```{r}

# I've got two columns, one with the company region and another with the employee region. I want to create a sankey diagram / migration flow chart
# that shows the number of employees that are from a certain region and work in a certain region.
# For it I have to create an auxiliar data frame with the number of employees that are from a certain region and work in a certain region.

# Create the auxiliar data frame where the rows and columns are the regions and the values are the number of employees that are from a certain region and work in a certain region.
# The auxiliar data frame will have the same number of rows and columns as the number of regions.
aux <- data.frame(matrix(0, nrow = length(levels(df$company_region)), ncol = length(levels(df$company_region))))
colnames(aux) <- levels(df$company_region)
rownames(aux) <- levels(df$company_region)

# Now calculate the number of employees that are from a certain region and work in a certain region.
for (i in 1:nrow(aux)) {
  for (j in 1:ncol(aux)) {
    aux[i, j] <- length(which(df$company_region == colnames(aux)[j] & df$employee_region == rownames(aux)[i]))
  }
}

# I need a long format
data_long <- aux %>%
  rownames_to_column %>%
  gather(key = 'key', value = 'value', -rowname) %>%
  filter(value > 0)
colnames(data_long) <- c("source", "target", "value")
data_long$target <- paste(data_long$target, " ", sep="")

# From these flows we need to create a node data frame: it lists every entities involved in the flow
nodes <- data.frame(name=c(as.character(data_long$source), as.character(data_long$target)) %>% unique())
 
# With networkD3, connection must be provided using id, not using real name like in the links dataframe.. So we need to reformat it.
data_long$IDsource=match(data_long$source, nodes$name)-1 
data_long$IDtarget=match(data_long$target, nodes$name)-1



# Make the Network
sankeyNetwork(Links = data_long, Nodes = nodes,
                     Source = "IDsource", Target = "IDtarget",
                     Value = "value", NodeID = "name", 
                     sinksRight=FALSE, nodeWidth=40, fontSize=13, nodePadding=20)

```



```{r}
levels(factor(df$job_title))  
```

```{r}
df$industry <- ifelse( grepl("data", df$job_title, ignore.case = T), "DATA", "OTHER")
df$industry <- ifelse( grepl("machine", df$job_title, ignore.case = T), "ML/AI", df$industry)
df$industry <- ifelse( grepl("ML", df$job_title, ignore.case = T), "ML/AI", df$industry)
df$industry <- ifelse( grepl("AI", df$job_title, ignore.case = T), "ML/AI", df$industry)
df$industry <- as.factor(df$industry)

df$boss <- ifelse(grepl("head", df$job_title, ignore.case = T), "YES", "NO")
df$boss <- ifelse(grepl("lead", df$job_title, ignore.case = T), "YES", df$boss)
df$boss <- ifelse(grepl("principal", df$job_title, ignore.case = T), "YES", df$boss)
df$boss <- ifelse(grepl("director", df$job_title, ignore.case = T), "YES", df$boss)
df$boss <- as.factor(df$boss)

df$role <- ifelse(grepl("scientist", df$job_title, ignore.case = T), "SCIENTIST", "OTHER")
df$role <- ifelse(grepl("engineer", df$job_title, ignore.case = T), "ENGINEER", df$role)
df$role <- ifelse(grepl("analyst", df$job_title, ignore.case = T), "ANALYST", df$role)
df$role <- ifelse(grepl("manager", df$job_title, ignore.case = T), "MANAGER", df$role)
df$role <- ifelse(grepl("architect", df$job_title, ignore.case = T), "ARCHITECT", df$role)
df$role <- ifelse(grepl("developer", df$job_title, ignore.case = T), "DEVELOPER", df$role)
df$role <- as.factor(df$role)

df$research <- ifelse(grepl("research", df$job_title, ignore.case = T), "YES", "NO")
df$research <- as.factor(df$research)

summary(df)

```
```{r}
mean(df$salary_in_usd)
mean(df[df$boss == 'NO', 'salary_in_usd'])
mean(df[df$boss == 'YES', 'salary_in_usd'])

```

```{r}
numerics_names <- colnames(df[, sapply(df, is.numeric)])
factors_names <- colnames(df[, sapply(df, is.factor)])

for (i in 1:length(numerics_names)){
  print(ggplot(df, aes_string(x= numerics_names[i])) +
    ggdist::stat_halfeye(
      adjust=0.5,
      justification = -.2,
      .width=0
    ) +
    geom_boxplot(
      width = .1,
      alpha = 0.5
    ) +
     labs(title=paste("Distribution and boxplot of",numerics_names[i]), y="count"))
}

for (i in 1:length(factors_names)){
  print(ggplot(df, aes_string(x= factors_names[i])) +
    geom_bar()+
     labs(title=paste("Histogram of",factors_names[i]),y="count"))
}
```

```{r}
plot(df$employee_residence, df$salary_in_usd, xlab="Employee Residence", ylab="Salary in USD")
plot(df$company_size, df$salary_in_usd, xlab="Company Size", ylab="Salary in USD")
plot(df$company_location, df$salary_in_usd, xlab="Company Location", ylab="Salary in USD")
plot(df$experience_level, df$salary_in_usd, xlab="Experience Level", ylab="Salary in USD")
plot(df$remote_ratio, df$salary_in_usd, xlab="Remote Ratio", ylab="Salary in USD")
```

```{r}

y_2020 <- df[df$work_year == 2020,]
y_2021 <- df[df$work_year == 2021,]
y_2022 <- df[df$work_year == 2022,]

y_2020 <- y_2020 %>% group_by(remote_ratio) %>% summarise(count = n())
y_2021 <- y_2021 %>% group_by(remote_ratio) %>% summarise(count = n())
y_2022 <- y_2022 %>% group_by(remote_ratio) %>% summarise(count = n())

y_2020$percentage <- y_2020$count / sum(y_2020$count) * 100
y_2021$percentage <- y_2021$count / sum(y_2021$count) * 100
y_2022$percentage <- y_2022$count / sum(y_2022$count) * 100

y_2020$work_year <- 2020
y_2021$work_year <- 2021
y_2022$work_year <- 2022

y <- rbind(y_2020, y_2021, y_2022)

ggplot(y, aes(x = work_year, y = percentage, group = remote_ratio, color = remote_ratio)) + geom_line() + geom_point() + labs(x = "Work Year", y = "Percentage of Remote Ratio", title = "Remote Ratio by Work Year") + theme(plot.title = element_text(hjust = 0.5))
```

# Questions

## 1. 
## 2. 
## 3. 
## 4.
## 5. 
## 6. 
## 7. Can we predict which employees are at risk of leaving their company? 

This could be useful for companies who want to retain their top talent and for employees that are underpaid. We could use different factors such to determine which employees are underpaid compared to their peers.

To answer this questions we will use two different techniques: Clustering and regression.

The following features will be used:
 - Experience level
 - Employment type
 - Industry
 - Employee region
 - Role
 - Remote_ratio
 - Boss
 - Research
 - Company size

### Clustering


First we create a separate dataframe for the variables we will use.
```{r}
# Select the variables to use in the clustering analysis
df_vars <- select(df, experience_level, employment_type, company_size, industry, employee_region, boss, research, role, remote_ratio)
                    
df_vars$experience_level <- as.numeric(df_vars$experience_level)
df_vars$industry <- as.numeric(df_vars$industry)
df_vars$employment_type <- as.numeric(df_vars$employment_type)
df_vars$company_size <- as.numeric(df_vars$company_size)
df_vars$employee_region <- as.numeric(df_vars$employee_region)
df_vars$role <- as.numeric(df_vars$role)
df_vars$boss <- as.numeric(df_vars$boss)
df_vars$research <- as.numeric(df_vars$research)
df_vars$remote_ratio <- as.numeric(df_vars$remote_ratio)

# Standardize the variables
df_vars <- scale(df_vars)

```


Let's find find the elbow in our plot, to find the "best" k for the kmeans algorithm
```{r}
results <- data.frame(k = integer(), WCSS = double())

# Loop through a range of values for k
for (k in 2:100) {
  # Run the k-means clustering algorithm
  km <- kmeans(df_vars, k, nstart = 10)
  # Store the results in the data frame
  results <- rbind(results, data.frame(k = k, WCSS = km$tot.withinss))
}

# Plot the WCSS values for each value of k
ggplot(results, aes(x = k, y = WCSS)) +
  geom_line() +
  geom_point() +
  labs(x = "Number of clusters (k)", y = "WCSS")
```


```{r}
# Perform k-means clustering with 3 clusters
kmeans_results <- kmeans(df_vars, 20)

df_Q7 <- df
# Add the cluster labels to the original data
df_Q7$cluster <- kmeans_results$cluster

# Inspect the clusters
group_by(df_Q7, cluster) %>%
  summarize(mean_salary = mean(salary_in_usd))
```


```{r}
fig1 <- plot_ly(df_Q7, x = ~as.numeric(employee_region), y = ~as.numeric(industry), z = ~as.numeric(experience_level), color = ~cluster)
fig1 <- fig1 %>% add_markers()

axx <- list(ticketmode = 'array', title="Employee region", ticktext = levels(df$employee_region),  tickvals = c(1,2,3,4,5,6,7),  range = c(1,7), tickangle = 25)
axy <- list(ticketmode = 'array', title="Industry", ticktext = levels(df$industry),  tickvals = c(1,2,3),  range = c(1,3), tickangle = 45)
axz <- list(ticketmode = 'array', title="Experience level", ticktext = levels(df$experience_level),  tickvals = c(1,2,3,4),  range = c(1,4), tickangle = 45)

fig1 <- fig1 %>% layout(scene = list(xaxis = axx, yaxis = axy, zaxis = axz))
fig1


fig2 <- plot_ly(df_Q7, x = ~as.numeric(role), y = ~as.numeric(industry), z = ~as.numeric(remote_ratio), color = ~cluster)
fig2 <- fig2 %>% add_markers()

axx <- list(ticketmode = 'array', title="Role", ticktext = levels(df$role),  tickvals = c(1,2,3,4,5,6,7),  range = c(1,7), tickangle = 25)
axy <- list(ticketmode = 'array', title="Industry", ticktext = levels(df$industry),  tickvals = c(1,2,3),  range = c(1,3), tickangle = 45)
axz <- list(ticketmode = 'array', title="Remote ratio", ticktext = levels(df$remote_ratio),  tickvals = c(1,2,3),  range = c(1,3), tickangle = 45)

fig2 <- fig2 %>% layout(scene = list(xaxis = axx, yaxis = axy, zaxis = axz))
fig2


fig3 <- plot_ly(df_Q7, x = ~as.numeric(role), y = ~as.numeric(industry), z = ~as.numeric(remote_ratio), color = ~cluster)
fig3 <- fig3 %>% add_markers()

axx <- list(ticketmode = 'array', title="Role", ticktext = levels(df$role),  tickvals = c(1,2,3,4,5,6,7),  range = c(1,7), tickangle = 25)
axy <- list(ticketmode = 'array', title="Industry", ticktext = levels(df$industry),  tickvals = c(1,2,3),  range = c(1,3), tickangle = 45)
axz <- list(ticketmode = 'array', title="Remote ratio", ticktext = levels(df$remote_ratio),  tickvals = c(1,2,3),  range = c(1,3), tickangle = 45)

fig3 <- fig3 %>% layout(scene = list(xaxis = axx, yaxis = axy, zaxis = axz))
fig3

```

```{r}
mean_salary <- tapply(df_Q7$salary_in_usd, df_Q7$cluster, mean)
# View the mean salary for each level of the experience_level variable
df_Q7$salary_difference_kmeans <- 0
df_Q7$predicted_salary_kmeans <-0

for (i in 1:nrow(df_Q7)) {
  cluster_index = match(df_Q7$cluster[i], names(mean_salary))
  df_Q7$salary_difference_kmeans[i] <- df_Q7$salary_in_usd[i] - mean_salary[cluster_index]
  df_Q7$predicted_salary_kmeans[i] <- mean_salary[cluster_index]
}


underpaid_employees_kmeans <- df_Q7[df_Q7$salary_difference_kmeans < 0, ]
overpaid_employees_kmeans <- df_Q7[df_Q7$salary_difference_kmeans > 0, ]

underpaid_employees_kmeans <- underpaid_employees_kmeans[order(underpaid_employees_kmeans$salary_difference_kmeans), ]
overpaid_employees_kmeans <- overpaid_employees_kmeans[order(overpaid_employees_kmeans$salary_difference_kmeans, decreasing = TRUE), ]

# View the underpaid and overpaid employees
head(underpaid_employees_kmeans, n = 10)
head(overpaid_employees_kmeans, n=10)
```


```{r}
model <- lm(salary_in_usd ~ experience_level + employment_type + employee_region + company_size + industry + role + boss + research + remote_ratio, data = df_Q7)
summary(model)
```

```{r}
df_Q7$predicted_salary_lm  <- predict(model, newdata = df_Q7)
df_Q7$salary_difference_lm <- df_Q7$salary_in_usd - df_Q7$predicted_salary_lm

# Use the salary difference column to identify underpaid and overpaid employees
underpaid_employees_lm <- df_Q7[df_Q7$salary_difference_lm < 0, ]
overpaid_employees_lm <- df_Q7[df_Q7$salary_difference_lm > 0, ]

underpaid_employees_lm <- underpaid_employees_lm[order(underpaid_employees_lm$salary_difference_lm), ]
overpaid_employees_lm <- overpaid_employees_lm[order(overpaid_employees_lm$salary_difference_lm, decreasing = TRUE), ]

# View the underpaid and overpaid employees
head(underpaid_employees_lm, n = 10)
head(overpaid_employees_lm, n=10)
```

```{r}
df_Q7 <- df_Q7[order(df_Q7$salary_in_usd),]
# Add a column to the dataframe with a sequence of integers
x <- 1:nrow(df_Q7)

df_Q7$color_lm <- ifelse(df_Q7$lm_ratio_error < -17.07, "red", 
                      ifelse(df_Q7$lm_ratio_error > 32.4, "yellow", "green"))

df_Q7$color_kmeans <- ifelse(df_Q7$kmeans_ratio_error < -18.88, "red", 
                      ifelse(df_Q7$kmeans_ratio_error > 40.26, "yellow", "green"))

p <- ggplot(df_Q7, aes(x = x, y = salary_in_usd))
p <- p + geom_point(aes(y = salary_in_usd))
p <- p + geom_point(aes(y = predicted_salary_lm), color = color_lm)
p

p <- ggplot(df_Q7, aes(x = x, y = salary_in_usd))
p <- p + geom_point(aes(y = salary_in_usd))
p <- p + geom_point(aes(y = predicted_salary_kmeans), color = color_kmeans)
p

df_Q7$mean_prediction <- (df_Q7$predicted_salary_kmeans + df_Q7$predicted_salary_lm)/2

p <- ggplot(df_Q7, aes(x = x, y = salary_in_usd))
p <- p + geom_point(aes(y = salary_in_usd))
p <- p + geom_point(aes(y = mean_prediction), color = "blue")
p

```

```{r}
df_Q7$kmeans_ratio_error <- ((df_Q7$predicted_salary_kmeans / df_Q7$salary_in_usd)-1)*100
df_Q7$lm_ratio_error <- ((df_Q7$predicted_salary_lm / df_Q7$salary_in_usd)-1)*100

```



## 8.
## 9. 
## 10. 
## 11. 
## 12.
## 13. 

```{r}
ggplot(df, aes(x = as.factor(work_year), y = salary_in_usd)) +
         geom_boxplot(varwidth=T, fill="lightblue") +
         labs(title = "Salary depending on the work year", x = "Year", y = "Salary in USD") +
         theme_minimal() + 
         scale_y_continuous(labels = scales::dollar_format())

ggplot(df, aes(x = experience_level, y = salary_in_usd)) +
         geom_boxplot(varwidth=T, fill="lightblue") +
         labs(title = "Salary depending on the experience level", x = "Experience level", y = "Salary in USD") +
         theme_minimal() + 
         scale_y_continuous(labels = scales::dollar_format())

ggplot(df, aes(x = employment_type, y = salary_in_usd)) +
         geom_boxplot(varwidth=T, fill="lightblue") +
         labs(title = "Salary depending on the employment type", x = "Employment type", y = "Salary in USD") +
         theme_minimal() + 
         scale_y_continuous(labels = scales::dollar_format())

ggplot(df, aes(x = employee_region, y = salary_in_usd)) +
         geom_boxplot(varwidth=T, fill="lightblue") +
         labs(title = "Salary depending on the employee region of residence", x = "Region of residence", y = "Salary in USD") +
         theme_minimal() + 
         scale_y_continuous(labels = scales::dollar_format())

ggplot(df, aes(x = company_size, y = salary_in_usd)) +
         geom_boxplot(varwidth=T, fill="lightblue") +
         labs(title = "Salary depending on the company size", x = "Company size", y = "Salary in USD") +
         theme_minimal() + 
         scale_y_continuous(labels = scales::dollar_format())

ggplot(df, aes(x = role, y = salary_in_usd)) +
         geom_boxplot(varwidth=T, fill="lightblue") +
         labs(title = "Salary depending on the role", x = "Role", y = "Salary in USD") +
         theme_minimal() + 
         scale_y_continuous(labels = scales::dollar_format())

ggplot(df, aes(x = industry, y = salary_in_usd)) +
         geom_boxplot(varwidth=T, fill="lightblue") +
         labs(title = "Salary depending on the industry", x = "Industry", y = "Salary in USD") +
         theme_minimal() + 
         scale_y_continuous(labels = scales::dollar_format())

ggplot(df, aes(x = boss, y = salary_in_usd)) +
         geom_boxplot(varwidth=T, fill="lightblue") +
         labs(title = "Salary depending on whether the employee has a leadership position", x = "Has a leadership position", y = "Salary in USD") +
         theme_minimal() + 
         scale_y_continuous(labels = scales::dollar_format())

ggplot(df, aes(x = research, y = salary_in_usd)) +
         geom_boxplot(varwidth=T, fill="lightblue") +
         labs(title = "Salary depending on whether the employee participates in research projects", x = "Works in research projects", y = "Salary in USD") +
         theme_minimal() + 
         scale_y_continuous(labels = scales::dollar_format())

```

## 14. 
## 15. 
